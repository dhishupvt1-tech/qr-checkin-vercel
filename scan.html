<!DOCTYPE html>
<html>
<head>
  <title>Scan</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>body{display:none}</style>
</head>
<body>

<h2>Scan QR</h2>
<div id="reader"></div>
<p id="status"></p>

<script>
const supabaseClient = supabase.createClient(
  "https://qwumwbmystwwhsjpllqn.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3dW13Ym15c3R3d2hzanBsbHFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0OTg0OTUsImV4cCI6MjA4NjA3NDQ5NX0.Pd9xovSIz0GwsZXBj1w79fe9HfsRCv1ZtWbkJ-Umh8M"
);

// HARD AUTH BLOCK
(async () => {
  const { data } = await supabaseClient.auth.getSession();
  if (!data.session) {
    window.location.href = "login.html";
  }
  document.body.style.display = "block";
})();

async function onScan(qr) {
  const { data } = await supabaseClient
    .from("attendees")
    .select("*")
    .eq("qr", qr)
    .single();

  if (!data) {
    status.innerText = "Invalid QR";
    return;
  }

  if (data.checked_in) {
    status.innerText = "Already checked in";
    return;
  }

  await supabaseClient
    .from("attendees")
    .update({ checked_in: true })
    .eq("id", data.id);

  status.innerText = "Check-in successful";
}

new Html5Qrcode("reader").start(
  { facingMode: "environment" },
  { fps: 10, qrbox: 250 },
  onScan
);
</script>

</body>
</html>
