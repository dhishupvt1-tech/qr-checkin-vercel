<!DOCTYPE html>
<html>
<head>
  <title>QR Check-In</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>

<h2>Scan QR</h2>
<div id="reader" style="width:300px"></div>
<p id="status"></p>

<script>
const SUPABASE_URL = "https://qwumwbmystwwhsjpllqn.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3dW13Ym15c3R3d2hzanBsbHFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0OTg0OTUsImV4cCI6MjA4NjA3NDQ5NX0.Pd9xovSIz0GwsZXBj1w79fe9HfsRCv1ZtWbkJ-Umh8M";
const status = document.getElementById("status");

function onScanSuccess(qr) {
  fetch(`${SUPABASE_URL}/rest/v1/attendees?qr=eq.${qr}`, {
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: "Bearer " + SUPABASE_KEY
    }
  })
  .then(res => res.json())
  .then(data => {
    if (!data.length) {
      status.innerText = "❌ Invalid QR";
      return;
    }
    if (data[0].checked_in) {
      status.innerText = "❌ Already Checked In";
    } else {
      fetch(`${SUPABASE_URL}/rest/v1/attendees?qr=eq.${qr}`, {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          apikey: SUPABASE_KEY,
          Authorization: "Bearer " + SUPABASE_KEY
        },
        body: JSON.stringify({
          checked_in: true,
          checked_in_at: new Date()
        })
      });
      status.innerText = "✅ Check-In Successful";
    }
  });
}

new Html5Qrcode("reader").start(
  { facingMode: "environment" },
  { fps: 10, qrbox: 250 },
  onScanSuccess
);
</script>
</body>
</html>
