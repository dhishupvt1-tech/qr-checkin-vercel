<!DOCTYPE html>
<html>
<head>
  <title>TANTRA 2026 | Scan</title>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="authGuard.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    *{margin:0;padding:0;box-sizing:border-box}

    body{
      background:linear-gradient(135deg,#0B1C2D,#081522);
      font-family:'Poppins',sans-serif;
      color:white;
      min-height:100vh;
    }

    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    .navbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:18px 40px;
      background:#11263F;
      box-shadow:0 4px 20px rgba(0,0,0,0.4);
    }

    .navbar a{
      color:#C9A44C;
      text-decoration:none;
      margin-left:20px;
    }

    .content{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:40px 20px;
    }

    h2{
      font-family:'Playfair Display',serif;
      color:#C9A44C;
      margin-bottom:30px;
    }

    /* SCANNER */
    .scanner-wrapper{
      position:relative;
      width:min(90vw,420px);
      aspect-ratio:1/1;
      border-radius:16px;
      overflow:hidden;
      background:black;
      box-shadow:0 20px 50px rgba(0,0,0,0.6);
      margin-bottom:30px;
    }

    #reader, #reader video{
      width:100% !important;
      height:100% !important;
      object-fit:cover !important;
    }

    .corner{
      width:60px;
      height:60px;
      border:5px solid #C9A44C;
      position:absolute;
    }

    .corner.tl{top:15px;left:15px;border-right:none;border-bottom:none}
    .corner.tr{top:15px;right:15px;border-left:none;border-bottom:none}
    .corner.bl{bottom:15px;left:15px;border-right:none;border-top:none}
    .corner.br{bottom:15px;right:15px;border-left:none;border-top:none}

    input{
      padding:12px;
      border-radius:8px;
      border:none;
      width:280px;
      margin-bottom:15px;
    }

    button{
      padding:12px 18px;
      background:#C9A44C;
      border:none;
      border-radius:8px;
      font-weight:600;
      cursor:pointer;
      margin:5px;
      transition:0.3s;
    }

    button:hover{
      background:#E6C36A;
      transform:translateY(-2px);
    }

    /* RESULT CARD */
    .result-card{
      margin-top:30px;
      width:100%;
      max-width:900px;
      background:#11263F;
      border-radius:18px;
      padding:30px;
      box-shadow:0 20px 60px rgba(0,0,0,0.6);
      display:flex;
      flex-wrap:wrap;
      gap:30px;
      align-items:center;
      justify-content:center;
      animation:fadeIn 0.4s ease;
    }

    .photo-section{
      flex:1;
      min-width:280px;
      display:flex;
      justify-content:center;
    }

    .photo-section img{
      width:100%;
      max-width:320px;
      height:auto;
      border-radius:16px;
      border:4px solid #C9A44C;
      box-shadow:0 15px 40px rgba(0,0,0,0.7);
      object-fit:cover;
    }

    .info-section{
      flex:1;
      min-width:280px;
      text-align:left;
    }

    .info-section h3{
      font-size:28px;
      color:#C9A44C;
      margin-bottom:10px;
    }

    .info-section p{
      margin-bottom:8px;
      font-size:16px;
    }

    .success{color:#7CFC7C;font-weight:600}
    .error{color:#FF6B6B;font-weight:600}

    @keyframes fadeIn{
      from{opacity:0;transform:translateY(10px)}
      to{opacity:1;transform:translateY(0)}
    }

    @media(max-width:768px){
      .result-card{
        flex-direction:column;
        text-align:center;
      }
      .info-section{
        text-align:center;
      }
    }

  </style>
</head>

<body>
<div class="page">

<nav class="navbar">
  <div style="font-family:'Playfair Display',serif;color:#C9A44C">TANTRA 2026</div>
  <div>
    <a href="register.html">Register</a>
    <a href="scan.html">Scan</a>
    <a href="admin.html">Admin</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="#" onclick="logout()">Logout</a>
  </div>
</nav>

<div class="content">

<h2>Scan Entry</h2>

<div class="scanner-wrapper">
  <div id="reader"></div>
  <div class="corner tl"></div>
  <div class="corner tr"></div>
  <div class="corner bl"></div>
  <div class="corner br"></div>
</div>

<input id="entryIdInput" placeholder="Manual Entry ID">
<button onclick="manualLookup()">Lookup</button>

<div id="result"></div>

</div>
</div>

<script>
const supabaseClient=supabase.createClient(
"https://qwumwbmystwwhsjpllqn.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3dW13Ym15c3R3d2hzanBsbHFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0OTg0OTUsImV4cCI6MjA4NjA3NDQ5NX0.Pd9xovSIz0GwsZXBj1w79fe9HfsRCv1ZtWbkJ-Umh8M"
);

let currentRecord=null;
let scannerInstance=null;

(async()=>{
const user=await requireAuth(supabaseClient);
if(!user)return;
initScanner();
})();

function initScanner(){
  const wrapper=document.querySelector(".scanner-wrapper");
  const size=wrapper.offsetWidth;

  scannerInstance=new Html5Qrcode("reader");

  scannerInstance.start(
    { facingMode:"environment" },
    { fps:10, qrbox:{ width:size-60, height:size-60 } },
    async qrText=>{
      const {data}=await supabaseClient
        .from("attendees")
        .select("*")
        .eq("qr",qrText)
        .single();

      if(!data){
        showMessage("❌ QR Not Found","error");
        return;
      }

      renderRecord(data);
    }
  );
}

function renderRecord(data){
currentRecord=data;

let status="";
let actions="";

if(data.status==="PENDING"){
actions=`<button onclick="updateStatus('CHECKED_IN')">✅ Check In</button>
<button onclick="updateStatus('REJECTED')">❌ Reject</button>`;
}
else if(data.status==="CHECKED_IN"){
status="<p class='success'>✅ Already Checked In</p>";
}
else{
status="<p class='error'>❌ Entry Rejected</p>";
}

const photoHTML=data.id_photo_url
? `<img src="${data.id_photo_url}">`
: "";

result.innerHTML=`
<div class="result-card">
  <div class="photo-section">
    ${photoHTML}
  </div>
  <div class="info-section">
    <h3>${data.name}</h3>
    <p>${data.email}</p>
    <p>Reg No: ${data.reg_no}</p>
    <p>Entry ID: ${data.entry_id}</p>
    ${status}
    ${actions}
  </div>
</div>`;
}

async function updateStatus(status){
await supabaseClient
.from("attendees")
.update({status})
.eq("entry_id",currentRecord.entry_id);

currentRecord.status=status;
renderRecord(currentRecord);
}

async function manualLookup(){
const id=entryIdInput.value.trim().toUpperCase();
const {data}=await supabaseClient
.from("attendees")
.select("*")
.eq("entry_id",id)
.single();

if(!data){
showMessage("❌ Invalid Entry ID","error");
return;
}

renderRecord(data);
}

function showMessage(text,type){
result.innerHTML=`<div class="result-card ${type}">${text}</div>`;
}

async function logout(){
await supabaseClient.auth.signOut();
window.location.href="login.html";
}
</script>

</body>
</html>
