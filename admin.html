<!DOCTYPE html>
<html>
<head>
  <title>TANTRA 2026 | Admin</title>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="authGuard.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}

    body{
      background:#0B1C2D;
      font-family:Arial;
      color:white;
      min-height:100vh;
    }

    .navbar{
      display:flex;
      justify-content:space-between;
      padding:20px 40px;
      background:#11263F;
    }

    .navbar a{
      color:#C9A44C;
      text-decoration:none;
      margin-left:18px;
    }

    .container{
      padding:40px;
      max-width:1400px;
      margin:auto;
    }

    h2{
      margin-bottom:20px;
      color:#C9A44C;
    }

    .search-box{
      margin-bottom:20px;
    }

    input{
      padding:10px;
      width:300px;
      border-radius:6px;
      border:none;
    }

    table{
      width:100%;
      border-collapse:collapse;
    }

    th,td{
      padding:10px;
      border:1px solid #1e3b5f;
      text-align:center;
    }

    th{
      background:#11263F;
      color:#C9A44C;
    }

    .badge{
      padding:4px 10px;
      border-radius:6px;
      font-size:12px;
    }

    .PENDING{background:#FFC107;color:black}
    .CHECKED_IN{background:#4CAF50}
    .REJECTED{background:#F44336}

    button{
      padding:6px 10px;
      margin:2px;
      border:none;
      cursor:pointer;
      border-radius:4px;
      font-weight:bold;
    }

    .btn-check{background:#4CAF50;color:white}
    .btn-reject{background:#F44336;color:white}
    .btn-delete{background:#555;color:white}
    .btn-qr{background:#C9A44C}
  </style>
</head>

<body>

<nav class="navbar">
  <div>TANTRA 2026</div>
  <div>
    <a href="register.html">Register</a>
    <a href="scan.html">Scan</a>
    <a href="admin.html">Admin</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="#" onclick="logout()">Logout</a>
  </div>
</nav>

<div class="container">

<h2>Admin Panel</h2>

<div class="search-box">
  <input id="searchInput" placeholder="Search name / email / reg no / entry id">
</div>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Email</th>
      <th>Reg No</th>
      <th>Entry ID</th>
      <th>Status</th>
      <th>Created By</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

</div>

<script>
const supabaseClient = supabase.createClient(
  "https://qwumwbmystwwhsjpllqn.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3dW13Ym15c3R3d2hzanBsbHFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0OTg0OTUsImV4cCI6MjA4NjA3NDQ5NX0.Pd9xovSIz0GwsZXBj1w79fe9HfsRCv1ZtWbkJ-Umh8M"
);

let allData = [];

(async () => {
  const user = await requireAuth(supabaseClient);
  if (!user) return;
  loadData();
})();

async function loadData() {
  const { data, error } = await supabaseClient
    .from("attendees")
    .select("*")
    .order("created_at", { ascending: false });

  if (error) {
    alert(error.message);
    return;
  }

  allData = data;
  renderTable(data);
}

function renderTable(data) {
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  data.forEach(a => {
    tbody.innerHTML += `
      <tr>
        <td>${a.name}</td>
        <td>${a.email}</td>
        <td>${a.reg_no}</td>
        <td>${a.entry_id}</td>
        <td><span class="badge ${a.status}">${a.status}</span></td>
        <td>${a.created_by || "-"}</td>
        <td>
          <button class="btn-check" onclick="updateStatus('${a.entry_id}','CHECKED_IN')">âœ”</button>
          <button class="btn-reject" onclick="updateStatus('${a.entry_id}','REJECTED')">âœ–</button>
          <button class="btn-delete" onclick="deleteUser('${a.entry_id}')">ðŸ—‘</button>
          <button class="btn-qr" onclick="viewQR('${encodeURIComponent(a.qr)}')">QR</button>
        </td>
      </tr>`;
  });
}

/* ðŸ”¥ SEARCH LOGIC */
document.getElementById("searchInput").addEventListener("input", function(){
  const value = this.value.toLowerCase();

  const filtered = allData.filter(a =>
    a.name.toLowerCase().includes(value) ||
    a.email.toLowerCase().includes(value) ||
    a.reg_no.toLowerCase().includes(value) ||
    a.entry_id.toLowerCase().includes(value)
  );

  renderTable(filtered);
});

/* STATUS UPDATE */
async function updateStatus(id,status){
  await supabaseClient.from("attendees")
    .update({status})
    .eq("entry_id",id);

  loadData();
}

/* DELETE */
async function deleteUser(id){
  if(!confirm("Delete this attendee?")) return;

  await supabaseClient.from("attendees")
    .delete()
    .eq("entry_id",id);

  loadData();
}

/* VIEW QR */
function viewQR(qrValue){
  window.open(`view-qr.html?qr=${qrValue}`,"_blank");
}

async function logout(){
  await supabaseClient.auth.signOut();
  window.location.href="login.html";
}
</script>

</body>
</html>
