<!DOCTYPE html>
<html>
<head>
  <title>TANTRA 2026 | Admin</title>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="authGuard.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}

    body{
      background:#0B1C2D;
      font-family:Arial;
      color:white;
      min-height:100vh;
    }

    .navbar{
      display:flex;
      justify-content:space-between;
      padding:20px 40px;
      background:#11263F;
    }

    .navbar a{
      color:#C9A44C;
      text-decoration:none;
      margin-left:18px;
    }

    .container{
      padding:40px;
      max-width:1500px;
      margin:auto;
    }

    h2{
      margin-bottom:20px;
      color:#C9A44C;
    }

    .top-controls{
      display:flex;
      justify-content:space-between;
      margin-bottom:20px;
      flex-wrap:wrap;
      gap:15px;
    }

    input, select{
      padding:10px;
      border-radius:6px;
      border:none;
      min-width:250px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
    }

    th,td{
      padding:10px;
      border:1px solid #1e3b5f;
      text-align:center;
      font-size:13px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    th{
      background:#11263F;
      color:#C9A44C;
    }

    .badge{
      padding:4px 8px;
      border-radius:6px;
      font-size:11px;
      font-weight:bold;
    }

    .PENDING{background:#FFC107;color:black}
    .CHECKED_IN{background:#4CAF50}
    .REJECTED{background:#F44336}

    button{
      padding:5px 8px;
      margin:2px;
      border:none;
      cursor:pointer;
      border-radius:4px;
      font-size:11px;
      font-weight:bold;
    }

    .btn-check{background:#4CAF50;color:white}
    .btn-reject{background:#F44336;color:white}
    .btn-delete{background:#555;color:white}
    .btn-qr{background:#C9A44C;color:black}

  </style>
</head>

<body>

<nav class="navbar">
  <div>TANTRA 2026</div>
  <div>
    <a href="register.html">Register</a>
    <a href="scan.html">Scan</a>
    <a href="admin.html">Admin</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="#" onclick="logout()">Logout</a>
  </div>
</nav>

<div class="container">

<h2>Admin Panel</h2>

<div class="top-controls">
  <input id="searchInput" placeholder="Search name / email / reg no / entry id">
  
  <select id="sortSelect">
    <option value="newest">Newest First</option>
    <option value="oldest">Oldest First</option>
    <option value="name">Sort by Name</option>
    <option value="status">Sort by Status</option>
  </select>
</div>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Email</th>
      <th>Reg No</th>
      <th>Entry ID</th>
      <th>Status</th>
      <th>Created By</th>
      <th style="width:200px;">Created At (IST)</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

</div>

<script>
const supabaseClient = supabase.createClient(
  "https://qwumwbmystwwhsjpllqn.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3dW13Ym15c3R3d2hzanBsbHFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0OTg0OTUsImV4cCI6MjA4NjA3NDQ5NX0.Pd9xovSIz0GwsZXBj1w79fe9HfsRCv1ZtWbkJ-Umh8M"
);

let allData = [];

(async () => {
  const user = await requireAuth(supabaseClient);
  if (!user) return;
  loadData();
})();

async function loadData() {
  const { data } = await supabaseClient
    .from("attendees")
    .select("*");

  allData = data;
  applyFilters();
}

/* SEARCH + SORT */
function applyFilters() {

  const searchValue = document.getElementById("searchInput").value.toLowerCase();
  const sortValue = document.getElementById("sortSelect").value;

  let filtered = allData.filter(a =>
    a.name.toLowerCase().includes(searchValue) ||
    a.email.toLowerCase().includes(searchValue) ||
    a.reg_no.toLowerCase().includes(searchValue) ||
    a.entry_id.toLowerCase().includes(searchValue)
  );

  if(sortValue === "newest"){
    filtered.sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));
  }

  if(sortValue === "oldest"){
    filtered.sort((a,b)=> new Date(a.created_at) - new Date(b.created_at));
  }

  if(sortValue === "name"){
    filtered.sort((a,b)=> a.name.localeCompare(b.name));
  }

  if(sortValue === "status"){
    filtered.sort((a,b)=> a.status.localeCompare(b.status));
  }

  renderTable(filtered);
}

function renderTable(data) {

  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  data.forEach(a => {

    const formattedDate = a.created_at
      ? new Date(a.created_at).toLocaleString("en-IN", {
          timeZone: "Asia/Kolkata",
          day: "2-digit",
          month: "short",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          hour12: true
        }).replace(",", " â€¢")
      : "-";

    tbody.innerHTML += `
      <tr>
        <td>${a.name}</td>
        <td>${a.email}</td>
        <td>${a.reg_no}</td>
        <td>${a.entry_id}</td>
        <td><span class="badge ${a.status}">${a.status}</span></td>
        <td>${a.created_by || "-"}</td>
        <td>${formattedDate}</td>
        <td>
          <button class="btn-check" onclick="updateStatus('${a.entry_id}','CHECKED_IN')">âœ”</button>
          <button class="btn-reject" onclick="updateStatus('${a.entry_id}','REJECTED')">âœ–</button>
          <button class="btn-delete" onclick="deleteUser('${a.entry_id}')">ðŸ—‘</button>
          <button class="btn-qr" onclick="viewQR('${encodeURIComponent(a.qr)}')">QR</button>
        </td>
      </tr>`;
  });
}

/* LIVE SEARCH */
document.getElementById("searchInput").addEventListener("input", applyFilters);

/* SORT */
document.getElementById("sortSelect").addEventListener("change", applyFilters);

/* STATUS UPDATE */
async function updateStatus(id,status){
  await supabaseClient.from("attendees")
    .update({status})
    .eq("entry_id",id);

  loadData();
}

/* DELETE */
async function deleteUser(id){
  if(!confirm("Delete this attendee?")) return;

  await supabaseClient.from("attendees")
    .delete()
    .eq("entry_id",id);

  loadData();
}

/* VIEW QR */
function viewQR(qrValue){
  window.open(`view-qr.html?qr=${qrValue}`,"_blank");
}

async function logout(){
  await supabaseClient.auth.signOut();
  window.location.href="login.html";
}
</script>

</body>
</html>
