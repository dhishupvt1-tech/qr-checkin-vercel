<!DOCTYPE html>
<html>
<head>
  <title>TANTRA 2026 | Admin</title>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="authGuard.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Playfair+Display:wght@600&display=swap" rel="stylesheet">

  <style>
    *{margin:0;padding:0;box-sizing:border-box}

    body{
      background:linear-gradient(135deg,#0B1C2D,#081522);
      font-family:'Poppins',sans-serif;
      color:white;
      min-height:100vh;
    }

    .page{min-height:100vh;display:flex;flex-direction:column}

    .navbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:18px 40px;
      background:#11263F;
      box-shadow:0 4px 20px rgba(0,0,0,0.4);
    }

    .navbar a{
      color:#C9A44C;
      text-decoration:none;
      margin-left:20px;
    }

    .content{
      flex:1;
      padding:40px;
      max-width:1400px;
      margin:auto;
      width:100%;
    }

    h2{
      font-family:'Playfair Display',serif;
      color:#C9A44C;
      margin-bottom:25px;
    }

    .controls{
      display:flex;
      gap:15px;
      margin-bottom:25px;
      flex-wrap:wrap;
    }

    input, select{
      padding:10px 14px;
      border-radius:8px;
      border:none;
      min-width:200px;
    }

    .stats{
      margin-bottom:20px;
      font-weight:500;
      color:#C9A44C;
    }

    .table-wrapper{
      background:#11263F;
      border-radius:12px;
      overflow:auto;
      box-shadow:0 10px 30px rgba(0,0,0,0.5);
    }

    table{
      width:100%;
      border-collapse:collapse;
      min-width:1100px;
    }

    th,td{
      padding:14px;
      text-align:center;
    }

    th{
      background:#0f2136;
      color:#C9A44C;
      position:sticky;
      top:0;
    }

    tr:hover{
      background:#1b3556;
    }

    .badge{
      padding:6px 10px;
      border-radius:6px;
      font-size:12px;
      font-weight:600;
    }

    .pending{background:#FFC107;color:black}
    .checked{background:#4CAF50;color:white}
    .rejected{background:#F44336;color:white}

    .action-btn{
      padding:6px 10px;
      border:none;
      border-radius:6px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      margin:2px;
    }

    .check-btn{background:#4CAF50;color:white}
    .reject-btn{background:#F44336;color:white}
    .delete-btn{background:#777;color:white}
    .qr-btn{background:#C9A44C;color:black}

    .action-btn:hover{opacity:0.8}

  </style>
</head>

<body>
<div class="page">

<nav class="navbar">
  <div style="font-family:'Playfair Display',serif;color:#C9A44C">TANTRA 2026</div>
  <div>
    <a href="register.html">Register</a>
    <a href="scan.html">Scan</a>
    <a href="admin.html">Admin</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="#" onclick="logout()">Logout</a>
  </div>
</nav>

<div class="content">

<h2>Admin Control Panel</h2>

<div class="controls">
  <input type="text" id="searchInput" placeholder="Search..." oninput="filterData()">
  <select id="statusFilter" onchange="filterData()">
    <option value="ALL">All Status</option>
    <option value="PENDING">Pending</option>
    <option value="CHECKED_IN">Checked In</option>
    <option value="REJECTED">Rejected</option>
  </select>
</div>

<div class="stats">
  Total Records: <span id="totalCount">0</span>
</div>

<div class="table-wrapper">
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Email</th>
      <th>Reg No</th>
      <th>Entry ID</th>
      <th>Status</th>
      <th>Created By</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>
</div>

</div>
</div>

<script>
const supabaseClient=supabase.createClient(
"https://qwumwbmystwwhsjpllqn.supabase.co",
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3dW13Ym15c3R3d2hzanBsbHFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0OTg0OTUsImV4cCI6MjA4NjA3NDQ5NX0.Pd9xovSIz0GwsZXBj1w79fe9HfsRCv1ZtWbkJ-Umh8M"
);

let allData=[];

(async()=>{
const user=await requireAuth(supabaseClient);
if(!user)return;
loadAdminData();
})();

async function loadAdminData(){
const {data,error}=await supabaseClient.from("attendees").select("*");

if(error){alert(error.message);return;}

allData=data;
document.getElementById("totalCount").innerText=data.length;
renderTable(data);
}

function renderTable(data){
const tbody=document.getElementById("tbody");
tbody.innerHTML="";

data.forEach(a=>{

let badgeClass="";
if(a.status==="PENDING")badgeClass="pending";
if(a.status==="CHECKED_IN")badgeClass="checked";
if(a.status==="REJECTED")badgeClass="rejected";

tbody.innerHTML+=`
<tr>
<td>${a.name}</td>
<td>${a.email}</td>
<td>${a.reg_no}</td>
<td>${a.entry_id}</td>
<td><span class="badge ${badgeClass}">${a.status}</span></td>
<td>${a.created_by || "-"}</td>
<td>
  <button class="action-btn check-btn" onclick="updateStatus('${a.entry_id}','CHECKED_IN')">✓</button>
  <button class="action-btn reject-btn" onclick="updateStatus('${a.entry_id}','REJECTED')">✕</button>
  <button class="action-btn qr-btn" onclick="viewQR('${encodeURIComponent(a.qr)}')">QR</button>
  <button class="action-btn delete-btn" onclick="deleteAttendee('${a.entry_id}')">Delete</button>
</td>
</tr>`;
});
}

async function updateStatus(entryId,newStatus){
await supabaseClient
.from("attendees")
.update({status:newStatus})
.eq("entry_id",entryId);

loadAdminData();
}

async function deleteAttendee(entryId){
const confirmDelete=confirm("Are you sure you want to delete this attendee?");
if(!confirmDelete)return;

await supabaseClient
.from("attendees")
.delete()
.eq("entry_id",entryId);

loadAdminData();
}

function filterData(){
const search=document.getElementById("searchInput").value.toLowerCase();
const status=document.getElementById("statusFilter").value;

let filtered=allData.filter(a=>{
const matchSearch=
a.name.toLowerCase().includes(search)||
a.email.toLowerCase().includes(search)||
a.reg_no.toLowerCase().includes(search)||
a.entry_id.toLowerCase().includes(search);

const matchStatus=status==="ALL"||a.status===status;

return matchSearch && matchStatus;
});

renderTable(filtered);
}

function viewQR(qrValue){
window.open(`view-qr.html?qr=${qrValue}`,"_blank");
}

async function logout(){
await supabaseClient.auth.signOut();
window.location.href="login.html";
}
</script>

</body>
</html>
